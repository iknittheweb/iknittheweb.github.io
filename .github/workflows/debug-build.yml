name: Debug: Build and upload artifact (no secrets)

on:
  workflow_dispatch:

jobs:
  debug-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Clean dist folder
        run: rm -rf dist || true

      - name: Run build:gh (no secrets)
        # This assumes you have a script named "build:gh" in package.json
        run: npm run build:gh
        shell: bash

      - name: List dist files
        run: |
          echo "=== dist files ==="
          ls -la dist || find . -maxdepth 2 -type f -name '*.html' -print

      - name: Show first 200 lines of up to 5 built HTML files
        run: |
          files=( $(find dist -type f -name '*.html' | head -n 5) )
          if [ ${#files[@]} -eq 0 ]; then
            echo "No HTML files found in dist"
          else
            for f in "${files[@]}"; do
              echo "===== $f ====="
              sed -n '1,200p' "$f" || true
            done
          fi

      - name: Grep for Handlebars-style placeholders in dist
        run: |
          echo "Searching for '{{...}}' patterns in dist"
          grep -R --line-number "{{[^}]*}}" dist || true

      - name: Upload dist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist
